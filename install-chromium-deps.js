const cp = require('child_process');
const util = require('util');

const KNOWN_DEPENDENCIES = [
  'adwaita-icon-theme',
  'at-spi2-core',
  'chromium-codecs-ffmpeg-extra',
  'dconf-gsettings-backend',
  'dconf-service',
  'fontconfig',
  'fontconfig-config',
  'fonts-dejavu-core',
  'glib-networking',
  'glib-networking-common',
  'glib-networking-services',
  'gsettings-desktop-schemas',
  'gtk-update-icon-cache',
  'hicolor-icon-theme',
  'humanity-icon-theme',
  'libasound2',
  'libasound2-data',
  'libatk-bridge2.0-0',
  'libatk1.0-0',
  'libatk1.0-data',
  'libatspi2.0-0',
  'libauthen-sasl-perl',
  'libavahi-client3',
  'libavahi-common-data',
  'libavahi-common3',
  'libcairo-gobject2',
  'libcairo2',
  'libcolord2',
  'libcroco3',
  'libcups2',
  'libdata-dump-perl',
  'libdatrie1',
  'libdconf1',
  'libdrm-amdgpu1',
  'libdrm-common',
  'libdrm-intel1',
  'libdrm-nouveau2',
  'libdrm-radeon1',
  'libdrm2',
  'libelf1',
  'libencode-locale-perl',
  'libepoxy0',
  'libfile-basedir-perl',
  'libfile-desktopentry-perl',
  'libfile-listing-perl',
  'libfile-mimeinfo-perl',
  'libfont-afm-perl',
  'libfontconfig1',
  'libfontenc1',
  'libfreetype6',
  'libgbm1',
  'libgdk-pixbuf2.0-0',
  'libgdk-pixbuf2.0-bin',
  'libgdk-pixbuf2.0-common',
  'libgl1',
  'libgl1-mesa-dri',
  'libgl1-mesa-glx',
  'libglapi-mesa',
  'libglvnd0',
  'libglx-mesa0',
  'libglx0',
  'libgraphite2-3',
  'libgtk-3-0',
  'libgtk-3-bin',
  'libgtk-3-common',
  'libharfbuzz0b',
  'libhtml-form-perl',
  'libhtml-format-perl',
  'libhtml-parser-perl',
  'libhtml-tagset-perl',
  'libhtml-tree-perl',
  'libhttp-cookies-perl',
  'libhttp-daemon-perl',
  'libhttp-date-perl',
  'libhttp-message-perl',
  'libhttp-negotiate-perl',
  'libice6',
  'libio-html-perl',
  'libio-socket-ssl-perl',
  'libipc-system-simple-perl',
  'libjbig0',
  'libjpeg-turbo8',
  'libjpeg8',
  'libjson-glib-1.0-0',
  'libjson-glib-1.0-common',
  'liblcms2-2',
  'libllvm10',
  'liblwp-mediatypes-perl',
  'liblwp-protocol-https-perl',
  'libmailtools-perl',
  'libnet-dbus-perl',
  'libnet-http-perl',
  'libnet-smtp-ssl-perl',
  'libnet-ssleay-perl',
  'libnspr4',
  'libnss3',
  'libpango-1.0-0',
  'libpangocairo-1.0-0',
  'libpangoft2-1.0-0',
  'libpciaccess0',
  'libpixman-1-0',
  'libpng16-16',
  'libproxy1v5',
  'librest-0.7-0',
  'librsvg2-2',
  'librsvg2-common',
  'libsm6',
  'libsoup-gnome2.4-1',
  'libsoup2.4-1',
  'libtext-iconv-perl',
  'libthai-data',
  'libthai0',
  'libtie-ixhash-perl',
  'libtiff5',
  'libtimedate-perl',
  'libtry-tiny-perl',
  'liburi-perl',
  'libwayland-client0',
  'libwayland-cursor0',
  'libwayland-egl1',
  'libwayland-server0',
  'libwww-perl',
  'libwww-robotrules-perl',
  'libx11-protocol-perl',
  'libx11-xcb1',
  'libxaw7',
  'libxcb-dri2-0',
  'libxcb-dri3-0',
  'libxcb-glx0',
  'libxcb-present0',
  'libxcb-render0',
  'libxcb-shape0',
  'libxcb-shm0',
  'libxcb-sync1',
  'libxcomposite1',
  'libxcursor1',
  'libxdamage1',
  'libxfixes3',
  'libxft2',
  'libxi6',
  'libxinerama1',
  'libxkbcommon0',
  'libxml-parser-perl',
  'libxml-twig-perl',
  'libxml-xpathengine-perl',
  'libxmu6',
  'libxpm4',
  'libxrandr2',
  'libxrender1',
  'libxshmfence1',
  'libxss1',
  'libxt6',
  'libxtst6',
  'libxv1',
  'libxxf86dga1',
  'libxxf86vm1',
  'perl-openssl-defaults',
  'ubuntu-mono',
  'x11-common',
  'x11-utils',
  'x11-xserver-utils',
  'xdg-utils',
  'xkb-data',
];

const execFile = util.promisify(cp.execFile);

async function installChromiumDeps() {
  const { stdout: simulateStdout } = await execFile('apt-get', [
    '--simulate',
    'install',
    'chromium-browser',
  ]);

  const dependencies = simulateStdout.split('\n').reduce((acc, cur) => {
    if (!/^Inst/.test(cur)) {
      return acc;
    }

    const [, dependency] = cur.split(' ');
    if (dependency.includes('chromium-browser')) {
      return acc;
    }

    return [...acc, dependency];
  }, []);

  for (const dep of KNOWN_DEPENDENCIES) {
    if (!dependencies.includes(dep)) {
      dependencies.push(dep);
    }
  }

  dependencies.sort();

  console.log('Installing chromium dependencies ...');
  console.log(JSON.stringify(dependencies));

  await execFile('apt-get', ['install', '-y', ...dependencies]);
}

void installChromiumDeps();
